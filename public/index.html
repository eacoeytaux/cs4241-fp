
<!DOCTYPE html>
<html lang="en">
<head>
	<title>CS4241 Final Project</title>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="css/style.css"/>
	<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Arvo">
	<link href="https://fonts.googleapis.com/css?family=Ubuntu+Condensed" rel="stylesheet"> 


	<!-- polyfill -->
	<script src="midi/inc/shim/Base64.js" type="text/javascript"></script>
	<script src="midi/inc/shim/Base64binary.js" type="text/javascript"></script>
	<script src="midi/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
	<!-- midi.js package -->
	<script src="midi/js/midi/audioDetect.js" type="text/javascript"></script>
	<script src="midi/js/midi/gm.js" type="text/javascript"></script>
	<script src="midi/js/midi/loader.js" type="text/javascript"></script>
	<script src="midi/js/midi/plugin.audiotag.js" type="text/javascript"></script>
	<script src="midi/js/midi/plugin.webaudio.js" type="text/javascript"></script>
	<script src="midi/js/midi/plugin.webmidi.js" type="text/javascript"></script>
	<!-- utils -->
	<script src="midi/js/util/dom_request_xhr.js" type="text/javascript"></script>
	<script src="midi/js/util/dom_request_script.js" type="text/javascript"></script>
</head>
<body>
	<div class="header">

		<h1 id="mainHeading"><img id="trexImg" src="images/trex2.png" alt="T-Rex Logo">maTRex</h1>
		<h3>Just the musical matrix that you are looking for!</h3>
	</div>

	<div class="content">

		<div id="buffer" class="side-panel"></div>

		<div id="matrix" draggable=false>
		</div>

		<div id="tools" class="side-panel">
			<div class="tool">
				<button type='button' id="addCol" onClick="addCol()">Add Column</button>
				<button type='button' id="removeCol" onClick="removeCol()">Remove Column</button>
			</div>

			<div class="tool">
				<button type='button' id="addRow" onClick="addRow()">Add Row</button>
				<button type='button' id="removeRow" onClick="removeRow()">Remove Row</button>
			</div>

			<div class="tool">
				<input type='text' id="tempoInput" placeholder="BPM" value="120">BPM
			</div>

			<div class="tool">
				<select id="instrumentInput">
					<option value="accordion">Accordion</option>
					<option value="acoustic_bass">Acoustic Bass</option>
  					<option value="acoustic_grand_piano">Acoustic Grand Piano</option>
  					<option value="acoustic_guitar_nylon">Acoustic Guitar Nylon</option>
  					<option value="acoustic_guitar_steel">Acoustic Guitar Steel</option>
  					<option value="agogo">Agogo</option>
  					<option value="alto_sax">Alto Sax</option>
  					<option value="applause">Applause</option>
  					<option value="banjo">Banjo</option>
  					<option value="baritone_sax">Baritone Sax</option>
  					<option value="bassoon">Bassoon</option>
  					<option value="bird_tweet">Bird Tweet</option>
  					<option value="blown_bottle">Blown Bottle
  					<option value="brass_section">Brass Section</option>
  					<option value="breath_noise">Breath Noise</option>
  					<option value="bright_acoustic_piano">Bright Acoustic Piano</option>
  					<option value="celesta">Celesta</option>
  					<option value="cello">Cello</option>
  					<option value="choir_aahs">Choir Aahs</option>
  					<option value="church_organ">Church Organ</option>
  					<option value="clarinet">Clarinet</option>
  					<option value="clavichord">Clavichord</option>
  					<option value="contrabass">Contrabass</option>
  					<option value="distortion_guitar">Distortion Guitar</option>
  					<option value="drawbar_organ">Drawbar Organ</option>
  					<option value="dulcimer">Dulcimer</option>
  					<option value="electric_bass_finger">Electric Bass Finger</option>
  					<option value="electric_bass_pick">Electric Bass Pick</option>
  					<option value="electric_grand_piano">Electric Grand Piano</option>
  					<option value="electric_guitar_clean">Electric Guitar Clean</option>
  					<option value="electric_guitar_jazz">Electric Guitar Jazz</option>
  					<option value="electric_guitar_muted">Electric Guitar Muted</option>
  					<option value="electric_piano_1">Electric Piano 1</option>
  					<option value="electric_piano_2">Electric Piano 2</option>
  					<option value="english_horn">English Horn</option>
  					<option value="fiddle">Fiddle</option>
  					<option value="flute">Flute</option>
  					<option value="french_horn">French Horn</option>
  					<option value="fretless_bass">Fretless Bass</option>
  					<option value="fx_1_rain">Fx 1 Rain</option>
  					<option value="fx_2_soundtrack">Fx 2 Soundtrack</option>
  					<option value="fx_3_crystal">Fx 3 Crystal</option>
  					<option value="fx_4_atmosphere">Fx 4 Atmosphere</option>
  					<option value="fx_5_brightness">Fx 5 Brightness</option>
  					<option value="fx_6_goblins">Fx 6 Goblins</option>
  					<option value="fx_7_echoes">Fx 7 Echoes</option>
  					<option value="fx_8_scifi">Fx 8 Scifi</option>
  					<option value="glockenspiel">Glockenspiel</option>
  					<option value="guitar_fret_noise">Guitar Fret Noise</option>
  					<option value="guitar_harmonics">Guitar Harmonics</option>
  					<option value="gunshot">Gunshot</option>
  					<option value="harmonica">Harmonica</option>
  					<option value="harpsichord">Harpsichord</option>
  					<option value="helicopter">Helicopter</option>
  					<option selected="selected" value="honkytonk_piano">Honkytonk Piano</option>
  					<option value="kalimba">Kalimba</option>
  					<option value="koto">Koto</option>
  					<option value="lead_1_square">Lead 1 Square</option>
  					<option value="lead_2_sawtooth">Lead 2 Sawtooth</option>
  					<option value="lead_3_calliope">Lead 3 Calliope</option>
  					<option value="lead_4_chiff">Lead 4 Chiff</option>
  					<option value="lead_5_charang">Lead 5 Charang</option>
  					<option value="lead_6_voice">Lead 6 Voice</option>
  					<option value="lead_7_fifths">Lead 7 Fifths</option>
  					<option value="lead_8_bass_lead">Lead 8 Bass Lead</option>
  					<option value="marimba">Marimba</option>
  					<option value="melodic_tom">Melodic Tom</option>
  					<option value="music_box">Music Box</option>
  					<option value="muted_trumpet">Muted Trumpet</option>
  					<option value="oboe">Oboe</option>
  					<option value="ocarina">Ocarina</option>
  					<option value="orchestra_hit">Orchestra Hit</option>
  					<option value="orchestral_harp">Orchestral Harp</option>
  					<option value="overdriven_guitar">Overdriven Guitar</option>
  					<option value="pad_1_new_age">Pad 1 New Age</option>
  					<option value="pad_2_warm">Pad 2 Warm</option>
  					<option value="pad_3_polysynth">Pad 3 Polysynth</option>
  					<option value="pad_4_choir">Pad 4 Choir</option>
  					<option value="pad_5_bowed">Pad 5 Bowed</option>
  					<option value="pad_6_metallic">Pad 6 Metallic</option>
  					<option value="pad_7_halo">Pad 7 Halo</option>
  					<option value="pad_8_sweep">Pad 8 Sweep</option>
  					<option value="pan_flute">Pan Flute</option>
  					<option value="percussive_organ">Percussive Organ</option>
  					<option value="piccolo">Piccolo</option>
  					<option value="pizzicato_strings">Pizzicato Strings</option>
  					<option value="recorder">Recorder</option>
  					<option value="reed_organ">Reed Organ</option>
  					<option value="reverse_cymbal">Reverse Cymbal</option>
  					<option value="rock_organ">Rock Organ</option>
  					<option value="seashore">Seashore</option>
  					<option value="shakuhachi">Shakuhachi</option>
  					<option value="shamisen">Shamisen</option>
  					<option value="shanai">Shanai</option>
  					<option value="sitar">Sitar</option>
  					<option value="slap_bass_1">Slap Bass 1</option>
  					<option value="slap_bass_2">Slap Bass 2</option>
  					<option value="soprano_sax">Soprano Sax</option>
  					<option value="steel_drums">Steel Drums</option>
  					<option value="string_ensemble_1">String Ensemble 1</option>
  					<option value="string_ensemble_2">String Ensemble 2</option>
  					<option value="synth_bass_1">Synth Bass 1</option>
  					<option value="synth_bass_2">Synth Bass 2</option>
  					<option value="synth_drum">Synth Drum</option>
  					<option value="synth_voice">Synth Voice</option>
  					<option value="synthbrass_1">Synthbrass 1</option>
  					<option value="synthbrass_2">Synthbrass 2</option>
  					<option value="synthstrings_1">Synthstrings 1</option>
  					<option value="synthstrings_2">Synthstrings 2</option>
  					<option value="taiko_drum">Taiko Drum</option>
  					<option value="tango_accordion">Tango Accordion</option>
  					<option value="telephone_ring">Telephone Ring</option>
  					<option value="tenor_sax">Tenor Sax</option>
  					<option value="timpani">Timpani</option>
  					<option value="tinkle_bell">Tinkle Bell</option>
  					<option value="tremolo_strings">Tremolo Strings</option>
  					<option value="trombone">Trombone</option>
  					<option value="trumpet">Trumpet</option>
  					<option value="tuba">Tuba</option>
  					<option value="tubular_bells">Tubular Bells</option>
  					<option value="vibraphone">Vibraphone</option>
  					<option value="viola">Viola</option>
  					<option value="violin">Violin</option>
  					<option value="voice_oohs">Voice Oohs</option>
  					<option value="whistle">Whistle</option>
  					<option value="woodblock">Woodblock</option>
  					<option value="xylophone">Xylophone</option>
				</select>
			</div>

			<div class="tool">
				<select>
					<option value="" disabled="disabled" selected="selected">Select a key</option>
					<option value="c">C</option>
					<option value="d">D</option>
				</select>
			</div>

			<div class="tool">
				<input type='color' id="colorPicker">
			</div>
		</div>

		<center><div class="tool">
			<input type='text' id="titleInput" placeholder="Title">
		</div>

		<div class="tool">
			<input type='text' id="authorInput" placeholder="Artist">
		</div>

		<div class="tool">
			<input type='text' id="descInput" placeholder="Description">
		</div></center>

		<center><div class="tool">
			<button type='button' id="saveBtn" onClick="save()">Save</button>
		</div></center>

		<center><div class="tool">
			<button type='button' id="deleteBtn" onClick="back()">Back</button>
		</div></center>


	</div>

</body>

<script>

// order goes [row][column]
noteArray = [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];

var height = 16;
var width = 16;
var currCol = 0;
var currColor = "#C05B73";
var beatsPerMin = 100;
var mouseClick = false;
var addColor = false;

function loadMIDI(instrumentName, cb) {
	MIDI.loadPlugin({
	soundfontUrl: "./soundfont/",
	instrument: instrumentName,
	onprogress: function(state, progress) {
		console.log(state, progress);
	},
	onsuccess: function() {
		MIDI.programChange(0, MIDI.GM.byName[instrumentName].number);
		if (cb) cb();
	}
	});
}

// Add event listeners to notes
window.onload = function() {
	loadMIDI("honkytonk_piano", function() {

			makeGet('/search-song?', function(data) {
				noteArray = data.songs[0].matrix;
				height = noteArray.length;
				width = noteArray[0].length;

				loadMatrix();
			});

			// mouse release event anywhere in the document disables mouse click
			document.addEventListener("mouseup", function(evt) {
				mouseClick = false;
			});

			document.getElementById("colorPicker").value = currColor;
			// color picker event listener
			document.getElementById("colorPicker").addEventListener("change", function() {
				currColor = document.getElementById("colorPicker").value;
			})

			// tempo input event listener
			document.getElementById("tempoInput").addEventListener("change", function() {
			    beatsPerMin = 6000 / document.getElementById("tempoInput").value; //TODO error checking

			    clearInterval(intervalVar);
			    intervalVar = window.setInterval(highlightCol, beatsPerMin);
			});

			// instrument input event listener
			document.getElementById("instrumentInput").addEventListener("change", function() {
				loadMIDI(document.getElementById("instrumentInput").value);
			});

			document.getElementById("trexImg").addEventListener("mouseover", function() {
				document.getElementById("trexImg").src = "images/trex3.png";
			});
			document.getElementById("trexImg").addEventListener("mouseout", function() {
				document.getElementById("trexImg").src = "images/trex2.png";
			});

			// title input event listener
			document.getElementById("titleInput").addEventListener("change", function() {
				// save the matrix title
				console.log("new title");
			});
			  
			// author input event listener
			document.getElementById("authorInput").addEventListener("change", function() {
				// save the matrix author
				console.log("new author");
			});
			  
			// description input event listener
			document.getElementById("descInput").addEventListener("change", function() {
				// save the matrix description
				console.log("new description");
			});
		});
}

var intervalVar = window.setInterval(highlightCol, beatsPerMin); // repeat forever, polling every 100 ms

function loadMatrix(song) {

	el = document.getElementById("matrix");
		//el.style.width = (40 * width) + "px";
		html = '<center>';

		// Add the correct number of notes to the matrix
		for(var row = 0; row < height; row++) {

			html = html + '<div class="row" draggable=false>';
			for(var col = 0; col < width; col++) {
				html = html + '<div id="' + row + ':' + col +'" class="notes row:' + row + ' col:' + col + '" draggable=false></div>';
			}
			html = html + '</div>';
		}
		el.innerHTML = html + '</center>';
		
		
		for(var row = 0; row < height; row++) {
			for(var col = 0; col < width; col++) {
				if(noteArray[row][col] == 1) {
					document.getElementById(row+ ':' + col).style.backgroundColor = '#F0F0F0';
				}
				else {
					document.getElementById(row+ ':' + col).style.backgroundColor = '#494949';
				}
			}
		}
		
		
		var notes = document.getElementsByClassName("notes");
		for (var i = 0; i < notes.length; i++) {
			notes[i].addEventListener("mousedown", function(evt) {

				// set the mouse click boolean to true
				mouseClick = true;
				// determine the row and column of the clicked noteArray
				var temp = evt.target.className.split(':')
				var row = temp[1].split(' ')[0];
				var col = temp[2];
				if(noteArray[row][col] == 0) {
					evt.target.style.backgroundColor = '#F0F0F0';
					noteArray[row][col] = 1;
					addColor = true;
				}
				else {
					evt.target.style.backgroundColor = '#494949';
					noteArray[row][col] = 0;
					addColor = false;
				}
			});
		}
		
		
		// handle mouse drag events
		for (var i = 0; i < notes.length; i++) {
			notes[i].addEventListener("mouseover", function(evt) {

				// change the note color if a mouse click has already occured
				if(mouseClick) {

					// determine the row and column of the clicked noteArray
					var temp = evt.target.className.split(':')
					var row = temp[1].split(' ')[0];
					var col = temp[2];
					if(addColor) {
						evt.target.style.backgroundColor = '#F0F0F0';
						noteArray[row][col] = 1;
					}
					else {
						evt.target.style.backgroundColor = '#494949';
						noteArray[row][col] = 0;
					}
				}
			});
		}
	}

	function highlightCol() {

	// Make any active cells white again
	var el; 
	for(var row = 0; row < height; row++) {
		if(noteArray[row][currCol]) {
			el = document.getElementById(row+ ':' + currCol);
			el.style.backgroundColor = '#F0F0F0';

			MIDI.noteOff(0, getNoteVal(row, 50), 0.75);
		}
	}

	// increment the currCol variable
	if(currCol < (width-1)) {
		currCol += 1;
	}
	else {
		currCol = 0;
	}

	// determine which notes are active
	for(var row = 0; row < height; row++) {
		if(noteArray[row][currCol]) {
			el = document.getElementById(row+ ':' + currCol)
			el.style.backgroundColor = currColor;

			MIDI.noteOn(0, getNoteVal(row, 50), 127, 0);
		}
	}
}

var pentatonicScale = [9, 7, 5, 3, 0];
function getNoteVal(col, offset) {
	var octave = Math.floor(col / 5);
	var noteVal = pentatonicScale[(col % 5)] - (octave * 12) + offset;
	return noteVal;
}

// add a column to the matrix
function addCol() {

	if(width < 16) {
		for(var row = 0; row < height; row++) {
			noteArray[row].push(0)
		}
		width += 1;
		loadMatrix();
	}
}

// remove a column from the matrix
function removeCol() {

	if(width > 0) {
		for(var row = 0; row < height; row++) {
			noteArray[row].splice(noteArray[row].length-1,noteArray[row].length)
		}
		width -= 1;
		loadMatrix();
	}
}

// add a row to the matrix
function addRow() {

	if(height < 16) {
		var newRow = []
		for(var col = 0; col < width; col++) {
			newRow.push(0);
		}
		noteArray.splice(0,0,newRow);
		height += 1;
		loadMatrix();
	}
}

// remove a row from the matrix
function removeRow() {
	
	if(height > 0) {
		noteArray.splice(0,1)
		height -= 1;
		loadMatrix();
	}
}


// function to handle saving of the current matrix
function save() {
	console.log("save");

	var song = {};

	song.name = document.getElementById("titleInput").value;
	song.artist = document.getElementById("authorInput").value;
	song.matrix = noteArray;
	song.height = noteArray.length;
	song.width = noteArray[0].length;
	song.comment = document.getElementById("descInput").value;
	song.color = document.getElementById("colorPicker").value;

	console.log("song data", song);
	makePost('add-song', JSON.stringify(song));
	
	loadHome();
}

// function to handle quitting the current matrix
function quit() {
	
	loadHome();
}

function back() {
	if (confirm("Just a head's up, you will lose any unsaved progress!") == true) {

	} else {

	}
}

// loads the home page
function loadHome() {


	clearInterval(intervalVar);

	html = "<h3>Great Feed of all of the other matrixes (is this the plural of matrix?)</h3>"
	console.log(html);
	
	document.getElementsByClassName("content")[0].innerHTML = html;

}

function makeGet(url, cb) {
	console.log('making GET', url);
	var req = new XMLHttpRequest();
	req.onreadystatechange = function() { handleRes(req, cb); }
	req.open('GET', url);
	req.send();
}

function makePost(url, params) {
	console.log('making POST', url);
	var req = new XMLHttpRequest();
	req.onreadystatechange = function() { console.log('POST complete'); }
	req.open('POST', url);
	req.send(params);
}

function handleRes(req, cb) {
	if (req.readyState !== XMLHttpRequest.DONE) {
		return;
	} else if (req.status === 200) {
		if (cb) cb(JSON.parse(req.responseText));
	}
}

</script>

</html>

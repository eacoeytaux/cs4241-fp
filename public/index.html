
<!DOCTYPE html>
<html lang="en">
<head>
	<title>CS4241 Final Project</title>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="css/style.css"/>
	<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Arvo">
</head>
<body>
	<div class="header">

		<h1 id="mainHeading"><img id="trexImg" src="images/trex2.png" alt="T-Rex Logo">maTRex</h1>
		<h3>Just the musical matrix that you are looking for!</h3>
	</div>

	<div class="content">

		<div id="buffer" class="side-panel"></div>

		<div id="matrix" draggable=false>
		</div>
		<div id="matrix"></div>

		<div id="tools" class="side-panel">
			<div class="tool">
				<button type='button' id="addCol" onClick="addCol()">Add Column</button>
				<button type='button' id="removeCol" onClick="removeCol()">Remove Column</button>
			</div>

			<div class="tool">
				<button type='button' id="addRow" onClick="addRow()">Add Row</button>
				<button type='button' id="removeRow" onClick="removeRow()">Remove Row</button>
			</div>

			<div class="tool">
				<input type='text' id="tempoInput" placeholder="BPM" value="120">
			</div>

			<div class="tool">
				<select>
					<option value="" disabled="disabled" selected="selected">Select a key</option>
					<option value="c">C</option>
					<option value="d">D</option>
				</select>
			</div>

			<div class="tool">
				<input type='color' id="colorPicker">
			</div>
		</div>

		<center><div class="tool">
			<input type='text' id="titleInput" placeholder="title" value="Title">
		</div>

		<div class="tool">
			<input type='text' id="authorInput" placeholder="artist" value="Artist">
		</div>

		<div class="tool">
			<input type='text' id="descInput" placeholder="desc" value="Description">
		</div></center>

		<center><div class="tool">
			<button type='button' id="saveBtn" onClick="save()">Save</button>
		</div></center>

		<center><div class="tool">
			<button type='button' id="deleteBtn" onClick="delete()">Delete</button>
		</div></center>


	</div>

</body>

<script>

// order goes [row][column]
noteArray = [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];

var height = 16;
var width = 16;
var currCol = 0;
var currColor = "#C05B73";
var beatsPerMin = 100;
var mouseClick = false;
var addColor = false;


// Add event listeners to notes
window.onload = function() {


	makeGet('/search-song?', function(data) {
		noteArray = data.songs[0].matrix;
		height = noteArray.length;
		width = noteArray[0].length;

		loadMatrix();
	});

	// mouse release event anywhere in the document disables mouse click
	document.addEventListener("mouseup", function(evt) {
		mouseClick = false;
	});

	// color picker event listener
	document.getElementById("colorPicker").addEventListener("change", function() {
		currColor = document.getElementById("colorPicker").value;
	})

	// tempo input event listener
	document.getElementById("tempoInput").addEventListener("change", function() {
    beatsPerMin = document.getElementById("tempoInput").value; //TODO error checking

    clearInterval(intervalVar);
    intervalVar = window.setInterval(highlightCol, beatsPerMin);
});

	document.getElementById("trexImg").addEventListener("mouseover", function() {
		document.getElementById("trexImg").src = "images/trex3.png";
	});
	document.getElementById("trexImg").addEventListener("mouseout", function() {
		document.getElementById("trexImg").src = "images/trex2.png";
	});

  // title input event listener
  document.getElementById("titleInput").addEventListener("change", function() {
	// save the matrix title
	console.log("new title");
});
  
  // author input event listener
  document.getElementById("authorInput").addEventListener("change", function() {
	// save the matrix author
	console.log("new author");
});
  
  // description input event listener
  document.getElementById("descInput").addEventListener("change", function() {
	// save the matrix description
	console.log("new description");
});
}

var intervalVar = window.setInterval(highlightCol, beatsPerMin); // repeat forever, polling every 100 ms

function loadMatrix(song) {

		el = document.getElementById("matrix");
		html = '<center>';

		// Add the correct number of notes to the matrix
		for(var row = 0; row < height; row++) {

			html = html + '<div class="row" draggable=false>';
			for(var col = 0; col < width; col++) {
				html = html + '<div id="' + row + ':' + col +'" class="notes row:' + row + ' col:' + col + '" draggable=false></div>';
			}
			html = html + '</div>';
		}
		el.innerHTML = html + '</center>';
		
		
		for(var row = 0; row < height; row++) {
			for(var col = 0; col < width; col++) {
				if(noteArray[row][col] == 1) {
					document.getElementById(row+ ':' + col).style.backgroundColor = '#F0F0F0';
				}
				else {
					document.getElementById(row+ ':' + col).style.backgroundColor = '#494949';
				}
			}
		}
		
		
		var notes = document.getElementsByClassName("notes");
		for (var i = 0; i < notes.length; i++) {
			notes[i].addEventListener("mousedown", function(evt) {

				// set the mouse click boolean to true
				mouseClick = true;
				// determine the row and column of the clicked noteArray
				var temp = evt.target.className.split(':')
				var row = temp[1].split(' ')[0];
				var col = temp[2];
				if(noteArray[row][col] == 0) {
					evt.target.style.backgroundColor = '#F0F0F0';
					noteArray[row][col] = 1;
					addColor = true;
				}
				else {
					evt.target.style.backgroundColor = '#494949';
					noteArray[row][col] = 0;
					addColor = false;
				}
			});
		}
		
		
		// handle mouse drag events
		for (var i = 0; i < notes.length; i++) {
			notes[i].addEventListener("mouseover", function(evt) {

				// change the note color if a mouse click has already occured
				if(mouseClick) {

					// determine the row and column of the clicked noteArray
					var temp = evt.target.className.split(':')
					var row = temp[1].split(' ')[0];
					var col = temp[2];
					if(addColor) {
						evt.target.style.backgroundColor = '#F0F0F0';
						noteArray[row][col] = 1;
					}
					else {
						evt.target.style.backgroundColor = '#494949';
						noteArray[row][col] = 0;
					}
				}
			});
		}
}

function highlightCol() {

	// Make any active cells white again
	var el; 
	for(var row = 0; row < height; row++) {
		if(noteArray[row][currCol]) {
			el = document.getElementById(row+ ':' + currCol)
			el.style.backgroundColor = '#F0F0F0';
		}
	}

	// increment the currCol variable
	if(currCol < (width-1)) {
		currCol += 1;
	}
	else {
		currCol = 0;
	}

	// determine which notes are active
	for(var row = 0; row < height; row++) {
		if(noteArray[row][currCol]) {
			el = document.getElementById(row+ ':' + currCol)
			el.style.backgroundColor = currColor;
		}
	}
}

// add a column to the matrix
function addCol() {

	if(width < 16) {
		for(var row = 0; row < height; row++) {
			noteArray[row].push(0)
		}
		width += 1;
		loadMatrix();
	}
}

// remove a column from the matrix
function removeCol() {

	if(width > 0) {
		for(var row = 0; row < height; row++) {
			noteArray[row].splice(noteArray[row].length-1,noteArray[row].length)
		}
		width -= 1;
		loadMatrix();
	}
}

// add a row to the matrix
function addRow() {

	if(height < 16) {
		var newRow = []
		for(var col = 0; col < width; col++) {
			newRow.push(0);
		}
		noteArray.splice(0,0,newRow);
		height += 1;
		loadMatrix();
	}
}

// remove a row from the matrix
function removeRow() {
	
	if(height > 0) {
		noteArray.splice(0,1)
		height -= 1;
		loadMatrix();
	}
}


// function to handle saving of the current matrix
function save() {
	console.log("save");

	var song = {};

	song.name = document.getElementById("titleInput").value;
	song.artist = document.getElementById("authorInput").value;
	song.matrix = noteArray;
	song.height = noteArray.length;
	song.width = noteArray[0].length;
	song.comment = document.getElementById("descInput").value;
	song.color = document.getElementById("colorPicker").value;

	console.log("song data", song);
	
	loadHome();
}

// function to handle quitting the current matrix
function quit() {
	
	loadHome();
}

// loads the home page
function loadHome() {


    clearInterval(intervalVar);

	html = "<h3>Great Feed of all of the other matrixes (is this the plural of matrix?)</h3>"
	console.log(html);
	
	document.getElementsByClassName("content")[0].innerHTML = html;

}

function makeGet(url, cb) {
	console.log('making GET', url);
	var req = new XMLHttpRequest();
	req.onreadystatechange = function() { handleRes(req, cb); }
	req.open('GET', url);
	req.send();
}

function makePost(url, params) {
	console.log('making POST', url);
	var req = new XMLHttpRequest();
	req.onreadystatechange = function() { console.log('POST complete'); }
	req.open('POST', url);
	req.send(params);
}

function handleRes(req, cb) {
	if (req.readyState !== XMLHttpRequest.DONE) {
		return;
	} else if (req.status === 200) {
		if (cb) cb(JSON.parse(req.responseText));
	}
}

</script>

</html>
